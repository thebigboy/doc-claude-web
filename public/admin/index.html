<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†åå° - Claude Code Web</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 500;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .back-btn, .logout-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .back-btn:hover, .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ä¸»ä½“å¸ƒå±€ */
    .main-container {
      display: flex;
      height: calc(100vh - 56px);
    }

    /* å·¦ä¾§èœå• */
    .sidebar {
      width: 200px;
      background: #2c3e50;
      color: #fff;
      overflow-y: auto;
    }

    .menu-item {
      padding: 16px 20px;
      cursor: pointer;
      transition: background 0.2s;
      border-left: 3px solid transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .menu-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .menu-item.active {
      background: rgba(255,255,255,0.15);
      border-left-color: #667eea;
    }

    /* å³ä¾§å†…å®¹åŒº */
    .content-area {
      flex: 1;
      overflow-y: auto;
      background: #f5f5f5;
    }

    .content-panel {
      display: none;
      padding: 20px;
    }

    .content-panel.active {
      display: block;
    }

    /* ç™»å½•ç•Œé¢ */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
      width: 400px;
    }

    .login-box h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-btn:hover {
      background: #5568d3;
    }

    .error-message {
      color: #f56565;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }

    /* çŸ¥è¯†åº“ç®¡ç†æ ·å¼ */
    .upload-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .upload-section h2 {
      margin-bottom: 20px;
      color: #333;
    }

    .upload-area {
      border: 2px dashed #667eea;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-area:hover {
      background: #f7fafc;
    }

    .upload-area.dragover {
      background: #e6f2ff;
      border-color: #3182ce;
    }

    .file-input {
      display: none;
    }

    .file-list-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .file-list-section h2 {
      margin-bottom: 20px;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f7fafc;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      font-weight: 600;
      color: #4a5568;
      font-size: 14px;
    }

    td {
      color: #2d3748;
      font-size: 14px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-pending {
      background: #feebc8;
      color: #7c2d12;
    }

    .status-processing {
      background: #bee3f8;
      color: #1e40af;
    }

    .status-completed {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-failed {
      background: #fed7d7;
      color: #742a2a;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-info {
      background: #4299e1;
      color: white;
    }

    .btn-info:hover {
      background: #3182ce;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #718096;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #718096;
    }

    /* èŠå¤©è®°å½•ç®¡ç†æ ·å¼ */
    .chat-management {
      display: flex;
      gap: 20px;
      height: calc(100vh - 96px);
    }

    .user-list-panel {
      width: 320px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .user-list-header {
      padding: 16px;
      background: #f7fafc;
      font-weight: 600;
      color: #333;
      border-bottom: 1px solid #e2e8f0;
    }

    .user-list {
      overflow-y: auto;
      max-height: calc(100vh - 150px);
    }

    .user-item {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .user-item:hover {
      background: #f5f5f5;
    }

    .user-item.active {
      background: #e8eaf6;
      border-left: 3px solid #667eea;
    }

    .user-name {
      font-size: 15px;
      font-weight: 500;
      color: #333;
      margin-bottom: 6px;
    }

    .user-meta {
      font-size: 12px;
      color: #888;
      display: flex;
      justify-content: space-between;
    }

    .chat-records-panel {
      flex: 1;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      padding: 20px;
    }

    .chat-records-header {
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e0e0e0;
    }

    .chat-records-header h2 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    .chat-card {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid #e2e8f0;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .chat-time {
      font-size: 12px;
      color: #888;
    }

    .chat-duration {
      font-size: 12px;
      color: #667eea;
      font-weight: 500;
    }

    .chat-section {
      margin-bottom: 12px;
    }

    .chat-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .chat-question {
      background: #e3f2fd;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .chat-answer {
      background: #fff;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
    }

    /* æ¨¡æ€æ¡† */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h3 {
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #718096;
    }

    .close-btn:hover {
      color: #2d3748;
    }

    .preview-content {
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.6;
      color: #2d3748;
    }
  </style>
</head>
<body>
  <!-- ç™»å½•ç•Œé¢ -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h2>ç®¡ç†å‘˜ç™»å½•</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="password">ç®¡ç†å‘˜å¯†ç </label>
          <input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " required>
        </div>
        <button type="submit" class="login-btn">ç™»å½•</button>
        <div id="loginError" class="error-message"></div>
      </form>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="mainContent" style="display: none;">
    <div class="header">
      <h1>ç®¡ç†åå° - Claude Code Web</h1>
      <div class="header-right">
        <button class="back-btn" onclick="window.location.href='/'">è¿”å›é¦–é¡µ</button>
        <button class="logout-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <div class="main-container">
      <!-- å·¦ä¾§èœå• -->
      <div class="sidebar">
        <div class="menu-item active" data-panel="knowledge">
          <span>ğŸ“š</span>
          <span>çŸ¥è¯†åº“ç®¡ç†</span>
        </div>
        <div class="menu-item" data-panel="batch">
          <span>ğŸ“¦</span>
          <span>æ‰¹é‡å¯¼å…¥</span>
        </div>
        <div class="menu-item" data-panel="chat">
          <span>ğŸ’¬</span>
          <span>èŠå¤©è®°å½•</span>
        </div>
      </div>

      <!-- å³ä¾§å†…å®¹åŒº -->
      <div class="content-area">
        <!-- çŸ¥è¯†åº“ç®¡ç†é¢æ¿ -->
        <div id="knowledgePanel" class="content-panel active">
          <div class="upload-section">
            <h2>ä¸Šä¼ PDFæ–‡ä»¶</h2>
            <div id="uploadArea" class="upload-area">
              <p>ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
              <p style="color: #718096; font-size: 14px; margin-top: 10px;">æ”¯æŒæœ€å¤§50MBçš„PDFæ–‡ä»¶</p>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".pdf">
          </div>

          <div class="file-list-section">
            <h2>æ–‡ä»¶åˆ—è¡¨</h2>
            <button id="refreshBtn" class="btn btn-info" style="margin-bottom: 15px;">åˆ·æ–°åˆ—è¡¨</button>
            <div id="fileListContainer">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
          </div>
        </div>

        <!-- æ‰¹é‡å¯¼å…¥é¢æ¿ -->
        <div id="batchPanel" class="content-panel">
          <div class="upload-section">
            <h2>æ‰¹é‡å¯¼å…¥ PDF / Markdown æ–‡ä»¶</h2>
            <p style="color: #718096; margin-bottom: 20px;">
              æ”¯æŒæ‰¹é‡é€‰æ‹©PDFå’ŒMarkdownæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ï¼šPDFæ–‡ä»¶å°†è½¬æ¢ä¸ºMDæ ¼å¼ï¼ŒMDæ–‡ä»¶å°†ç›´æ¥å¯¼å…¥çŸ¥è¯†åº“
            </p>

            <div class="batch-options" style="margin-bottom: 20px;">
              <button id="selectFilesBtn" class="btn btn-primary" style="margin-right: 10px;">
                é€‰æ‹©æ–‡ä»¶
              </button>
              <button id="selectFolderBtn" class="btn btn-info">
                é€‰æ‹©æ–‡ä»¶å¤¹
              </button>
              <input type="file" id="batchFileInput" class="file-input" accept=".pdf,.md" multiple>
              <input type="file" id="batchFolderInput" class="file-input" webkitdirectory directory multiple>
            </div>

            <div id="batchFileList" style="margin-top: 20px; display: none;">
              <h3 style="margin-bottom: 10px;">å·²é€‰æ‹©çš„æ–‡ä»¶ï¼š</h3>
              <div id="selectedFilesContainer" style="max-height: 300px; overflow-y: auto; background: #f9fafb; border: 1px solid #e2e8f0; border-radius: 5px; padding: 15px;">
              </div>
              <div style="margin-top: 15px;">
                <button id="startImportBtn" class="btn btn-success" style="margin-right: 10px;">
                  å¼€å§‹å¯¼å…¥
                </button>
                <button id="clearSelectionBtn" class="btn btn-danger">
                  æ¸…ç©ºé€‰æ‹©
                </button>
              </div>
            </div>

            <div id="batchProgress" style="margin-top: 20px; display: none;">
              <h3 style="margin-bottom: 10px;">å¯¼å…¥è¿›åº¦ï¼š</h3>
              <div style="background: #f9fafb; border: 1px solid #e2e8f0; border-radius: 5px; padding: 15px;">
                <div id="progressInfo"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- èŠå¤©è®°å½•ç®¡ç†é¢æ¿ -->
        <div id="chatPanel" class="content-panel">
          <div class="chat-management">
            <div class="user-list-panel">
              <div class="user-list-header">ç”¨æˆ·åˆ—è¡¨</div>
              <div class="user-list" id="userListContainer">
                <div class="loading">åŠ è½½ä¸­...</div>
              </div>
            </div>
            <div class="chat-records-panel" id="chatRecordsContainer">
              <div class="empty-state">
                <p style="font-size: 16px; margin-bottom: 10px;">ğŸ“‹</p>
                <p>è¯·ä»å·¦ä¾§é€‰æ‹©ç”¨æˆ·æŸ¥çœ‹ä¼šè¯è®°å½•</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="previewTitle">æ–‡ä»¶é¢„è§ˆ</h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="previewBody" class="preview-content"></div>
    </div>
  </div>

  <script>
    // ===== è®¤è¯ç®¡ç† =====
    async function checkLoginStatus() {
      try {
        const res = await fetch('/api/admin/status');
        const data = await res.json();

        if (data.isAdmin) {
          document.getElementById('loginOverlay').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          initializePanels();
        } else {
          document.getElementById('loginOverlay').style.display = 'flex';
          document.getElementById('mainContent').style.display = 'none';
        }
      } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
      }
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');

      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await res.json();

        if (data.success) {
          checkLoginStatus();
        } else {
          errorDiv.textContent = data.error || 'ç™»å½•å¤±è´¥';
        }
      } catch (error) {
        errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/api/admin/logout', { method: 'POST' });
        checkLoginStatus();
      } catch (error) {
        console.error('é€€å‡ºå¤±è´¥:', error);
      }
    });

    // ===== èœå•åˆ‡æ¢ =====
    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', function() {
        const panelName = this.getAttribute('data-panel');

        // æ›´æ–°èœå•æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        this.classList.add('active');

        // åˆ‡æ¢å†…å®¹é¢æ¿
        document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(panelName + 'Panel').classList.add('active');

        // åŠ è½½å¯¹åº”é¢æ¿çš„æ•°æ®
        if (panelName === 'knowledge') {
          loadFiles();
        } else if (panelName === 'chat') {
          loadUsers();
        }
      });
    });

    function initializePanels() {
      loadFiles(); // é»˜è®¤åŠ è½½çŸ¥è¯†åº“
    }

    // ===== çŸ¥è¯†åº“ç®¡ç† =====
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    });

    async function handleFileUpload(file) {
      if (!file.name.toLowerCase().endsWith('.pdf')) {
        alert('åªèƒ½ä¸Šä¼ PDFæ–‡ä»¶');
        return;
      }

      if (file.size > 50 * 1024 * 1024) {
        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MB');
        return;
      }

      const formData = new FormData();
      formData.append('pdf', file);

      try {
        uploadArea.innerHTML = '<p>ä¸Šä¼ ä¸­...</p>';
        const res = await fetch('/api/admin/upload', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.success) {
          alert(data.message);
          loadFiles();
          uploadArea.innerHTML = '<p>ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p><p style="color: #718096; font-size: 14px; margin-top: 10px;">æ”¯æŒæœ€å¤§50MBçš„PDFæ–‡ä»¶</p>';
        } else {
          alert('ä¸Šä¼ å¤±è´¥: ' + data.error);
          uploadArea.innerHTML = '<p>ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p><p style="color: #718096; font-size: 14px; margin-top: 10px;">æ”¯æŒæœ€å¤§50MBçš„PDFæ–‡ä»¶</p>';
        }
      } catch (error) {
        alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
        uploadArea.innerHTML = '<p>ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p><p style="color: #718096; font-size: 14px; margin-top: 10px;">æ”¯æŒæœ€å¤§50MBçš„PDFæ–‡ä»¶</p>';
      }

      fileInput.value = '';
    }

    async function loadFiles() {
      const container = document.getElementById('fileListContainer');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const res = await fetch('/api/admin/files');
        const data = await res.json();

        if (data.files && data.files.length > 0) {
          renderFileList(data.files);
        } else {
          container.innerHTML = '<div class="empty-state">æš‚æ— æ–‡ä»¶</div>';
        }
      } catch (error) {
        container.innerHTML = '<div class="error-message">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
      }
    }

    function renderFileList(files) {
      const container = document.getElementById('fileListContainer');

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>æ–‡ä»¶å</th>
            <th>å¤§å°</th>
            <th>çŠ¶æ€</th>
            <th>ä¸Šä¼ æ—¶é—´</th>
            <th>è½¬æ¢æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${files.map(file => `
            <tr>
              <td>${escapeHtml(file.original_name)}</td>
              <td>${formatFileSize(file.file_size)}</td>
              <td><span class="status-badge status-${file.status}">${getStatusText(file.status)}</span></td>
              <td>${formatDate(file.uploaded_at)}</td>
              <td>${file.converted_at ? formatDate(file.converted_at) : '-'}</td>
              <td>
                <div class="action-buttons">
                  ${file.status === 'completed' ? `<button class="btn btn-info" onclick="previewFile(${file.id})">é¢„è§ˆ</button>` : ''}
                  ${file.status === 'failed' || file.status === 'completed' ? `<button class="btn btn-success" onclick="reconvertFile(${file.id})">é‡è½¬</button>` : ''}
                  <button class="btn btn-danger" onclick="deleteFile(${file.id})">åˆ é™¤</button>
                </div>
                ${file.error_message ? `<div style="color: #f56565; font-size: 12px; margin-top: 5px;">${escapeHtml(file.error_message)}</div>` : ''}
              </td>
            </tr>
          `).join('')}
        </tbody>
      `;

      container.innerHTML = '';
      container.appendChild(table);
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN');
    }

    function getStatusText(status) {
      const statusMap = {
        pending: 'ç­‰å¾…ä¸­',
        processing: 'è½¬æ¢ä¸­',
        completed: 'å·²å®Œæˆ',
        failed: 'å¤±è´¥'
      };
      return statusMap[status] || status;
    }

    async function previewFile(id) {
      const modal = document.getElementById('previewModal');
      const title = document.getElementById('previewTitle');
      const body = document.getElementById('previewBody');

      modal.classList.add('show');
      body.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const res = await fetch(`/api/admin/preview/${id}`);
        const data = await res.json();

        if (data.content) {
          title.textContent = data.filename;
          body.textContent = data.content;
        } else {
          body.innerHTML = '<div class="error-message">åŠ è½½å¤±è´¥: ' + data.error + '</div>';
        }
      } catch (error) {
        body.innerHTML = '<div class="error-message">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
      }
    }

    async function reconvertFile(id) {
      if (!confirm('ç¡®å®šè¦é‡æ–°è½¬æ¢è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) return;

      try {
        const res = await fetch(`/api/admin/convert/${id}`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          alert(data.message);
          loadFiles();
        } else {
          alert('æ“ä½œå¤±è´¥: ' + data.error);
        }
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
      }
    }

    async function deleteFile(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

      try {
        const res = await fetch(`/api/admin/files/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (data.success) {
          alert('åˆ é™¤æˆåŠŸ');
          loadFiles();
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + data.error);
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    function closeModal() {
      document.getElementById('previewModal').classList.remove('show');
    }

    document.getElementById('previewModal').addEventListener('click', (e) => {
      if (e.target.id === 'previewModal') {
        closeModal();
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', loadFiles);

    // ===== èŠå¤©è®°å½•ç®¡ç† =====
    let currentUsername = null;

    async function loadUsers() {
      const container = document.getElementById('userListContainer');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const res = await fetch('/api/admin/users');
        const data = await res.json();

        if (data.users && data.users.length > 0) {
          renderUserList(data.users);
        } else {
          container.innerHTML = '<div class="empty-state">æš‚æ— ä¼šè¯è®°å½•</div>';
        }
      } catch (err) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err);
        container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      }
    }

    function renderUserList(users) {
      const container = document.getElementById('userListContainer');
      container.innerHTML = '';

      users.forEach(user => {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        if (currentUsername === user.username) {
          userItem.classList.add('active');
        }

        const lastTime = new Date(user.last_chat_time).toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });

        userItem.innerHTML = `
          <div class="user-name">${escapeHtml(user.username)}</div>
          <div class="user-meta">
            <span>å…± ${user.chat_count} æ¬¡</span>
            <span>${lastTime}</span>
          </div>
        `;

        userItem.addEventListener('click', () => {
          loadChats(user.username);
        });

        container.appendChild(userItem);
      });
    }

    async function loadChats(username) {
      currentUsername = username;

      // æ›´æ–°ç”¨æˆ·åˆ—è¡¨é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      const container = document.getElementById('chatRecordsContainer');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const res = await fetch(`/api/admin/chats/${encodeURIComponent(username)}`);
        const data = await res.json();

        if (data.chats && data.chats.length > 0) {
          renderChats(data.chats, data.username);
        } else {
          container.innerHTML = '<div class="empty-state">è¯¥ç”¨æˆ·æš‚æ— ä¼šè¯è®°å½•</div>';
        }
      } catch (err) {
        console.error('åŠ è½½ä¼šè¯è®°å½•å¤±è´¥:', err);
        container.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      }
    }

    function renderChats(chats, username) {
      const container = document.getElementById('chatRecordsContainer');
      container.innerHTML = '';

      const header = document.createElement('div');
      header.className = 'chat-records-header';
      header.innerHTML = `<h2>${escapeHtml(username)} çš„ä¼šè¯è®°å½•ï¼ˆå…± ${chats.length} æ¡ï¼‰</h2>`;
      container.appendChild(header);

      chats.forEach((chat, index) => {
        const card = document.createElement('div');
        card.className = 'chat-card';

        const chatTime = new Date(chat.created_at).toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        card.innerHTML = `
          <div class="chat-header">
            <span class="chat-time">${chatTime}</span>
            <span class="chat-duration">è€—æ—¶ ${chat.duration_seconds || 0} ç§’</span>
          </div>

          <div class="chat-section">
            <div class="chat-label">é—®é¢˜ #${chats.length - index}</div>
            <div class="chat-question">${escapeHtml(chat.question)}</div>
          </div>

          <div class="chat-section">
            <div class="chat-label">å›ç­”</div>
            <div class="chat-answer">${escapeHtml(chat.answer || '(æ— å›ç­”)')}</div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===== æ‰¹é‡å¯¼å…¥åŠŸèƒ½ =====
    const selectFilesBtn = document.getElementById('selectFilesBtn');
    const selectFolderBtn = document.getElementById('selectFolderBtn');
    const batchFileInput = document.getElementById('batchFileInput');
    const batchFolderInput = document.getElementById('batchFolderInput');
    const batchFileList = document.getElementById('batchFileList');
    const selectedFilesContainer = document.getElementById('selectedFilesContainer');
    const startImportBtn = document.getElementById('startImportBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const batchProgress = document.getElementById('batchProgress');
    const progressInfo = document.getElementById('progressInfo');

    let selectedFiles = [];

    selectFilesBtn.addEventListener('click', () => {
      batchFileInput.click();
    });

    selectFolderBtn.addEventListener('click', () => {
      batchFolderInput.click();
    });

    batchFileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        addFilesToSelection(Array.from(e.target.files));
      }
    });

    batchFolderInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        addFilesToSelection(Array.from(e.target.files));
      }
    });

    function addFilesToSelection(files) {
      // è¿‡æ»¤åªä¿ç•™ PDF å’Œ MD æ–‡ä»¶
      const validFiles = files.filter(file => {
        const ext = file.name.toLowerCase();
        return ext.endsWith('.pdf') || ext.endsWith('.md');
      });

      if (validFiles.length === 0) {
        alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„ PDF æˆ– MD æ–‡ä»¶');
        return;
      }

      // æ·»åŠ åˆ°é€‰æ‹©åˆ—è¡¨ï¼ˆé¿å…é‡å¤ï¼‰
      validFiles.forEach(file => {
        const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
        if (!exists) {
          selectedFiles.push(file);
        }
      });

      renderSelectedFiles();
      batchFileList.style.display = 'block';
    }

    function renderSelectedFiles() {
      selectedFilesContainer.innerHTML = '';

      if (selectedFiles.length === 0) {
        selectedFilesContainer.innerHTML = '<div style="color: #888; text-align: center;">æš‚æ— é€‰æ‹©çš„æ–‡ä»¶</div>';
        return;
      }

      const groupedFiles = {
        pdf: selectedFiles.filter(f => f.name.toLowerCase().endsWith('.pdf')),
        md: selectedFiles.filter(f => f.name.toLowerCase().endsWith('.md'))
      };

      let html = '';

      if (groupedFiles.pdf.length > 0) {
        html += `<div style="margin-bottom: 15px;">
          <strong style="color: #333;">PDF æ–‡ä»¶ (${groupedFiles.pdf.length} ä¸ª):</strong>
          <div style="margin-top: 8px;">`;
        groupedFiles.pdf.forEach((file, index) => {
          html += `<div style="padding: 6px 10px; margin: 4px 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; color: #333;">${escapeHtml(file.name)} (${formatFileSize(file.size)})</span>
            <button class="btn btn-danger" style="padding: 2px 8px; font-size: 11px;" onclick="removeFile(${index})">ç§»é™¤</button>
          </div>`;
        });
        html += '</div></div>';
      }

      if (groupedFiles.md.length > 0) {
        html += `<div style="margin-bottom: 15px;">
          <strong style="color: #333;">Markdown æ–‡ä»¶ (${groupedFiles.md.length} ä¸ª):</strong>
          <div style="margin-top: 8px;">`;
        groupedFiles.md.forEach((file, index) => {
          const actualIndex = groupedFiles.pdf.length + index;
          html += `<div style="padding: 6px 10px; margin: 4px 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; color: #333;">${escapeHtml(file.name)} (${formatFileSize(file.size)})</span>
            <button class="btn btn-danger" style="padding: 2px 8px; font-size: 11px;" onclick="removeFile(${actualIndex})">ç§»é™¤</button>
          </div>`;
        });
        html += '</div></div>';
      }

      html += `<div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border-radius: 4px; font-size: 13px; color: #333;">
        <strong>æ€»è®¡:</strong> ${selectedFiles.length} ä¸ªæ–‡ä»¶
        (PDF: ${groupedFiles.pdf.length}, MD: ${groupedFiles.md.length})
      </div>`;

      selectedFilesContainer.innerHTML = html;
    }

    window.removeFile = function(index) {
      selectedFiles.splice(index, 1);
      renderSelectedFiles();

      if (selectedFiles.length === 0) {
        batchFileList.style.display = 'none';
      }
    };

    clearSelectionBtn.addEventListener('click', () => {
      selectedFiles = [];
      batchFileInput.value = '';
      batchFolderInput.value = '';
      batchFileList.style.display = 'none';
      batchProgress.style.display = 'none';
    });

    startImportBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      if (!confirm(`ç¡®å®šè¦å¯¼å…¥ ${selectedFiles.length} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) {
        return;
      }

      startImportBtn.disabled = true;
      selectFilesBtn.disabled = true;
      selectFolderBtn.disabled = true;
      clearSelectionBtn.disabled = true;

      batchProgress.style.display = 'block';
      progressInfo.innerHTML = `<div style="color: #666; font-size: 14px;">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</div>`;

      try {
        const formData = new FormData();
        selectedFiles.forEach(file => {
          formData.append('files', file);
        });

        const res = await fetch('/api/admin/batch-import', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.success) {
          progressInfo.innerHTML = `
            <div style="color: #22543d; font-size: 14px; margin-bottom: 10px;">
              âœ“ ä¸Šä¼ æˆåŠŸï¼å…± ${data.summary.total} ä¸ªæ–‡ä»¶
            </div>
            <div style="color: #666; font-size: 13px;">
              æ­£åœ¨åå°å¤„ç† ${data.summary.processing} ä¸ªæ–‡ä»¶ï¼Œè¯·ç¨ååˆ·æ–°æ–‡ä»¶åˆ—è¡¨æŸ¥çœ‹ç»“æœã€‚
            </div>
            <button class="btn btn-primary" style="margin-top: 15px;" onclick="finishImport()">å®Œæˆ</button>
          `;
        } else {
          progressInfo.innerHTML = `
            <div style="color: #742a2a; font-size: 14px;">
              âœ— å¯¼å…¥å¤±è´¥: ${escapeHtml(data.error || 'æœªçŸ¥é”™è¯¯')}
            </div>
            <button class="btn btn-primary" style="margin-top: 15px;" onclick="resetImport()">é‡è¯•</button>
          `;
        }
      } catch (error) {
        progressInfo.innerHTML = `
          <div style="color: #742a2a; font-size: 14px;">
            âœ— ç½‘ç»œé”™è¯¯: ${escapeHtml(error.message)}
          </div>
          <button class="btn btn-primary" style="margin-top: 15px;" onclick="resetImport()">é‡è¯•</button>
        `;
      }
    });

    window.finishImport = function() {
      selectedFiles = [];
      batchFileInput.value = '';
      batchFolderInput.value = '';
      batchFileList.style.display = 'none';
      batchProgress.style.display = 'none';

      startImportBtn.disabled = false;
      selectFilesBtn.disabled = false;
      selectFolderBtn.disabled = false;
      clearSelectionBtn.disabled = false;

      // åˆ‡æ¢åˆ°çŸ¥è¯†åº“ç®¡ç†é¢æ¿å¹¶åˆ·æ–°åˆ—è¡¨
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
      document.querySelector('[data-panel="knowledge"]').classList.add('active');
      document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('knowledgePanel').classList.add('active');
      loadFiles();
    };

    window.resetImport = function() {
      startImportBtn.disabled = false;
      selectFilesBtn.disabled = false;
      selectFolderBtn.disabled = false;
      clearSelectionBtn.disabled = false;
      batchProgress.style.display = 'none';
    };

    // åˆå§‹åŒ–
    checkLoginStatus();
  </script>
</body>
</html>
